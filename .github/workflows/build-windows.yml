name: Build Windows Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
  push:
    tags:
      - 'v*'

jobs:
  build-portable:
    name: Build Portable Windows Package
    runs-on: windows-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi
      
      - name: Create portable package
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $packageDir = "GridBotChuck-$version-portable"
          
          # Create package directory structure
          New-Item -ItemType Directory -Path $packageDir -Force
          New-Item -ItemType Directory -Path "$packageDir/config" -Force
          New-Item -ItemType Directory -Path "$packageDir/logs" -Force
          New-Item -ItemType Directory -Path "$packageDir/data" -Force
          
          # Copy Python files
          Copy-Item -Path "main.py" -Destination $packageDir
          Copy-Item -Path "dashboard_launcher.py" -Destination $packageDir
          Copy-Item -Path "adaptive_scanner.py" -Destination $packageDir
          Copy-Item -Path "signal_logger.py" -Destination $packageDir
          Copy-Item -Path "requirements.txt" -Destination $packageDir
          
          # Copy core modules
          Copy-Item -Path "core" -Destination $packageDir -Recurse
          Copy-Item -Path "config" -Destination $packageDir -Recurse -Force
          Copy-Item -Path "strategies" -Destination $packageDir -Recurse
          Copy-Item -Path "utils" -Destination $packageDir -Recurse
          Copy-Item -Path "optimization" -Destination $packageDir -Recurse
          
          # Copy launcher scripts
          Copy-Item -Path "dashboard_launcher.bat" -Destination $packageDir
          Copy-Item -Path "dashboard_launcher.ps1" -Destination $packageDir
          
          # Copy documentation
          Copy-Item -Path "README.md" -Destination $packageDir
          Copy-Item -Path "LICENSE.txt" -Destination $packageDir
          Copy-Item -Path "QUICK_REFERENCE.md" -Destination $packageDir
          
          # Create example config (remove API keys)
          if (Test-Path "config/config.example.json") {
            Copy-Item -Path "config/config.example.json" -Destination "$packageDir/config/config.json"
          }
          
          # Create .env.example
          @"
          # Exchange API Keys
          # Get your API keys from your exchange (Kraken, Coinbase, Binance, etc.)
          
          EXCHANGE_API_KEY=your_api_key_here
          EXCHANGE_SECRET_KEY=your_secret_key_here
          
          # Optional: Exchange-specific keys (override EXCHANGE_* keys)
          # KRAKEN_API_KEY=your_kraken_api_key
          # KRAKEN_SECRET_KEY=your_kraken_secret_key
          # COINBASE_API_KEY=your_coinbase_api_key
          # COINBASE_SECRET_KEY=your_coinbase_secret_key
          "@ | Out-File -FilePath "$packageDir/.env.example" -Encoding utf8
          
          # Create START.bat launcher
          @"
          @echo off
          echo =====================================
          echo   GridBot Chuck - Trading Bot
          echo =====================================
          echo.
          
          REM Check for Python
          python --version >nul 2>&1
          if errorlevel 1 (
              echo ERROR: Python not found!
              echo Please install Python 3.11+ from python.org
              pause
              exit /b 1
          )
          
          REM Check for venv
          if not exist ".venv" (
              echo Creating virtual environment...
              python -m venv .venv
              call .venv\Scripts\activate.bat
              pip install -r requirements.txt
          ) else (
              call .venv\Scripts\activate.bat
          )
          
          echo Starting dashboard...
          python dashboard_launcher.py
          pause
          "@ | Out-File -FilePath "$packageDir/START.bat" -Encoding ascii
          
          # Create INSTALL.bat
          @"
          @echo off
          echo =====================================
          echo   GridBot Chuck - Installation
          echo =====================================
          echo.
          
          REM Check for Python
          python --version >nul 2>&1
          if errorlevel 1 (
              echo ERROR: Python not found!
              echo.
              echo Please install Python 3.11 or higher from:
              echo   https://www.python.org/downloads/
              echo.
              echo Make sure to check "Add Python to PATH" during installation!
              pause
              exit /b 1
          )
          
          echo Python found. Creating virtual environment...
          python -m venv .venv
          
          echo Activating environment...
          call .venv\Scripts\activate.bat
          
          echo Installing dependencies...
          pip install -r requirements.txt
          
          echo.
          echo =====================================
          echo   Installation Complete!
          echo =====================================
          echo.
          echo Next steps:
          echo 1. Copy .env.example to .env
          echo 2. Add your exchange API keys to .env
          echo 3. Run START.bat to launch the dashboard
          echo.
          pause
          "@ | Out-File -FilePath "$packageDir/INSTALL.bat" -Encoding ascii
          
          # Remove __pycache__ directories
          Get-ChildItem -Path $packageDir -Recurse -Directory -Filter "__pycache__" | Remove-Item -Recurse -Force
          
          # Create zip archive
          Compress-Archive -Path $packageDir -DestinationPath "GridBotChuck-$version-windows-portable.zip"
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: GridBotChuck-${{ steps.version.outputs.VERSION }}-windows-portable
          path: GridBotChuck-${{ steps.version.outputs.VERSION }}-windows-portable.zip

  build-pyinstaller:
    name: Build PyInstaller Executable
    runs-on: windows-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi
      
      - name: Build with PyInstaller
        run: |
          pyinstaller --name GridBotChuck `
            --onedir `
            --windowed `
            --add-data "config;config" `
            --add-data "strategies;strategies" `
            --add-data "core;core" `
            --add-data "utils;utils" `
            --hidden-import ccxt `
            --hidden-import pandas `
            --hidden-import numpy `
            --hidden-import aiohttp `
            --hidden-import apprise `
            main.py
      
      - name: Package executable
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          Compress-Archive -Path "dist/GridBotChuck" -DestinationPath "GridBotChuck-$version-windows-exe.zip"
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: GridBotChuck-${{ steps.version.outputs.VERSION }}-windows-exe
          path: GridBotChuck-${{ steps.version.outputs.VERSION }}-windows-exe.zip

  create-release:
    name: Create Release
    needs: [build-portable, build-pyinstaller]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Download portable artifact
        uses: actions/download-artifact@v4
        with:
          name: GridBotChuck-${{ steps.version.outputs.VERSION }}-windows-portable
      
      - name: Download exe artifact
        uses: actions/download-artifact@v4
        with:
          name: GridBotChuck-${{ steps.version.outputs.VERSION }}-windows-exe
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: GridBot Chuck v${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
          generate_release_notes: true
          files: |
            GridBotChuck-${{ steps.version.outputs.VERSION }}-windows-portable.zip
            GridBotChuck-${{ steps.version.outputs.VERSION }}-windows-exe.zip
          body: |
            ## GridBot Chuck v${{ steps.version.outputs.VERSION }}
            
            ### ðŸ“¦ Downloads
            
            | Package | Description |
            |---------|-------------|
            | `GridBotChuck-${{ steps.version.outputs.VERSION }}-windows-portable.zip` | Portable version (requires Python 3.11+) |
            | `GridBotChuck-${{ steps.version.outputs.VERSION }}-windows-exe.zip` | Standalone executable (no Python required) |
            
            ### ðŸš€ Quick Start (Portable Version)
            1. Download and extract the portable zip
            2. Run `INSTALL.bat` to set up dependencies
            3. Copy `.env.example` to `.env` and add your API keys
            4. Run `START.bat` to launch the dashboard
            
            ### ðŸš€ Quick Start (Executable Version)
            1. Download and extract the exe zip
            2. Create a `config/config.json` with your settings
            3. Run `GridBotChuck.exe`
            
            ### ðŸ“‹ Requirements
            - Windows 10 or later
            - Exchange API keys (Kraken, Coinbase, or Binance)
